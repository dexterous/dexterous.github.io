---
layout: post
title: The Case of the Undying Thread
publish_on: 2011-08-15

---

<div class="post-body entry-content">
<p></p><div>It was just another app, a simple little web app just like any  other; except it wasn't so simple. I was minding my business, adding  freshen to our arsenal when that little tick reared it funny little head  up. At first I didn't get it. 'What's going on here?!?' I thought to  myself, 'I just asked for the app to be stopped. I mean... I just  SIGINT'd the damn thing for crying out loud!' I was at wit's end; what  rogue magic held the application in place even after I'd killed it?</div>  <div><br></div><div>I decided it wan't really important so I'd go ahead  with the tests and terminate the process manually for now. But it mocked  me every time I ran nose. All those <b><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">^Z</span></b>s followed with <span style="color:rgb(0, 102, 0);font-family:courier new,monospace">kill %1</span>s  we starting to get on my nerves. There's only so many times I could  invoke Albert Cahalan's spells. I just couldn't take it any more.</div>  <div><br></div><div>Then it struck me. The clue lie in a benign looking log entry the app spit out just as it got ready to accept requests-</div><div><br></div><div style="color:rgb(51, 51, 255);font-family:courier new,monospace"> Jul 13,18:56:23,108 DEBUG [140612639590144][pluto.<wbr>integration.excel_upload][272] <span class="il">Excel</span> Upload <span class="il">Worker</span> <span class="il">thread</span> is running.</div> <div><br></div><div>'Isn't anybody stopping that <span class="il">thread</span>?' my subconscious wondered as I try to work out where that <span class="il">thread</span> was being started. A couple of grep's later I was at the <span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">bottom of </span><span style="border-collapse:collapse;font-family:arial, sans-serif;font-size:13px"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">pluto.config.middleware.</span><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">mak<wbr>e_app</span>, eyeing at that <span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">start_excelworker()</span> call...</span></div>  <div><span style="border-collapse:collapse;font-family:arial, sans-serif;font-size:13px"><br></span></div><font style="color:rgb(51, 51, 255);font-family:courier new,monospace" face="arial, sans-serif"><span style="border-collapse:collapse">    ## starting the <span class="il">excel</span> work <span class="il">thread</span> here...</span></font><div style="color:rgb(51, 51, 255);font-family:courier new,monospace"> <span style="border-collapse:collapse">    from pluto.integration.excel_upload import start_excelworker</span></div> <div style="color:rgb(51, 51, 255);font-family:courier new,monospace"><span style="border-collapse:collapse">    start_excelworker()</span></div><br><div>... that lead to ...</div><div><br></div><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">def start_excelworker():</span><div style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> <div>    <span class="il">worker</span> = ExcelUploadWorkerThread()</div><div>    <span class="il">worker</span>.start()</div></div><div><br></div> <div>... and there it was! The moment I realized that <span class="il">worker</span> was local to the <span style="color:rgb(51, 51, 255);font-family:courier new,monospace">start_excelworker</span> function I knew we'd found our culprit. Now the chase was on. It was a matter of getting of hold of the rogue <span class="il">thread</span> and disposing of him appropriately at the right moment.</div>  <div><br></div><div>Immediately, my Java-trained mind went into a flurry imagining what lifecycle hook I could use to stop <span class="il">worker</span>.  I tried to imagine where in the code there could be a destroy function  or a finalize or something of that sort. Except, Pylons has no lifecycle  hooks! Dammit, foiled!</div>  <div><br></div><div>'No matter, we'll come back to that later.' I said to myself, 'First let's try to figure out how to stop a <span class="il">thread</span> in Python.' A creature of habit, I went to the definitive reference- the <a href="http://docs.python.org/release/2.6.6/library/" target="_blank">Python 2.6.6 Standard Library reference</a>, specifically the <a href="http://docs.python.org/release/2.6.6/library/threading.html" target="_blank">threading API</a>. My first instinct was to look for a method called stop, but my Java-trained neurons fired up an old pathway leading to <a href="http://download.oracle.com/javase/6/docs/api/java/lang/Thread.html#stop%28%29" target="_blank">a warning sign</a> I hadn't seen in quite a while. Once I got over the brief rush of endorphin, my eyes locked on to <a href="http://download.oracle.com/javase/6/docs/api/java/lang/Thread.html#interrupt%28%29" target="_blank">j.l.<span class="il">Thread</span>.interrupt()</a> and I looked for a parallel in Python's threading module. But there wasn't one, foiled again!</div>  <div><br></div><div>Having lost the trail twice, I decided to tread  cautiously. All other options eliminated, the optimal solution suggested  in that warning from the javadocs seemed like the best course. So I set  about putting up a signpost in the code to tell <span class="il">worker</span> to... stop running.<br></div><div><br><span style="color:rgb(51, 51, 255);font-family:courier new,monospace">class ExcelUploadWorkerThread:</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"><span style="color:rgb(51, 51, 255);font-family:courier new,monospace">    def __init__(self):</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"> <span style="color:rgb(51, 51, 255);font-family:courier new,monospace">        super(ExcelUploadWorkerThread, self).__init__()</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"><span style="color:rgb(51, 51, 255);font-family:courier new,monospace">        self.interrupted = False</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"> <br style="color:rgb(51, 51, 255);font-family:courier new,monospace"><span style="color:rgb(51, 51, 255);font-family:courier new,monospace">    def run(self):</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"> <span style="color:rgb(51, 51, 255);font-family:courier new,monospace">        while not self.interrupted:</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"><span style="color:rgb(51, 51, 255);font-family:courier new,monospace">            try:</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"> <span style="color:rgb(51, 51, 255);font-family:courier new,monospace">                #doing some work</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"><span style="color:rgb(51, 51, 255);font-family:courier new,monospace">            except: #when the shit happens</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"> <span style="color:rgb(51, 51, 255);font-family:courier new,monospace">        except: #when the shit hits the fan</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"> <span style="color:rgb(51, 51, 255);font-family:courier new,monospace">    def interrupt(self):</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"><span style="color:rgb(51, 51, 255);font-family:courier new,monospace">        self.interrupted = True</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace">  </div><br>Now the trap was set; all that remained was to spring it! Which  dropped me smack dab in the middle of my first problem-  Pylons.has.no.frickin.<div><wbr>lifecycle.hooks!!! A little Googling quickly revealed the atexit module and from there I got...<br><br><div style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><div><span class="il">worker</span> = ExcelUploadWorkerThread()<br><br></div></div><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">def start_excelworker():</span><div style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> <div>    <span class="il">worker</span>.start()</div></div><div style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><br></div><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">def stop_excelworker():</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> <span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">    <span class="il">worker</span>.interrupt()</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> <span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">atexit.register(stop_<wbr>excelworker)</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><br>Feeling  confident that I'd snare him this time, I brewed up a pot of tea and  then settled in for the kill. I fired up the app, waited for it to warm  up and start the <span class="il">worker</span> <span class="il">thread</span>, and then... BAM! <b><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">^C</span></b><br><br>Except, nothing happened. And didn't I feel like an ass when I realized why absolutely nothing worked. <span style="color:rgb(51, 51, 255);font-family:courier new,monospace">atexit.register</span>  registers a function to be called just before the python process dies.  So I was writing code to allow the process to die but was triggering it  when the process was about to... die. How's that for irony?<br><br>No, I was going to have to catch on to the chain of events much  earlier. Much before the process actually started to die. I was going to  have to trigger it along with the interrupt I initiated at the console.  So got down to the business of handling the SIGINT signal.<br><br><div><span style="border-collapse:collapse;font-family:arial, sans-serif;font-size:13px"></span></div><font style="color:rgb(51, 51, 255);font-family:courier new,monospace" face="arial, sans-serif"><span style="border-collapse:collapse">    ## starting the <span class="il">excel</span> work <span class="il">thread</span> here...</span></font><div style="color:rgb(51, 51, 255);font-family:courier new,monospace"> <span style="border-collapse:collapse">    from pluto.integration.excel_upload import start_excelworker</span></div> <div style="color:rgb(51, 51, 255);font-family:courier new,monospace"><span style="border-collapse:collapse">    start_excelworker()</span></div><span style="color:rgb(51, 51, 255);font-family:courier new,monospace">    signal.signal(signal.SIGINT, handle_interrupt_signal)</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"> <br style="color:rgb(51, 51, 255);font-family:courier new,monospace"><span style="color:rgb(51, 51, 255);font-family:courier new,monospace">def handle_interrupt_signal(<wbr>signum, frame):</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"> <span style="color:rgb(51, 51, 255);font-family:courier new,monospace">    signal.signal(signum, signal.SIG_DFL)</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"><span style="color:rgb(51, 51, 255);font-family:courier new,monospace">    stop_excelworker():</span><br style="color:rgb(51, 51, 255);font-family:courier new,monospace"><br>And now I was ready. 'Do your worst, ' I said to <span class="il">worker</span> mockingly, 'your absolute worst!' <b><span style="color:rgb(51, 51, 255);font-family:courier new,monospace">^C</span></b><br><br>And  nothing! This was beginning to get a little harrowing. I was starting  to have nightmares of rouge workers running away with my processes and  there was seemingly nothing I could do about it! Foiled yet again! But I  decided to labour on.<br><br>I quickly realized that the <span class="il">worker</span> wasn't  even getting to the signpost I'd setup instructing him to stop. I took  off my glasses and gently rubbed my burning eyes as I noticed that the  'work' in question was delivered to the <span class="il">worker</span> via a Queue and the <span class="il">worker</span> was too busy waiting of the next work item coming off the queue to notice that I'd changed the sign.<br><div><br><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">excel_worker_q = queue.Queue()</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> <span style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> class ExcelUploadWorkerThread:</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">     def __init__(self):</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">         super(ExcelUploadWorkerThread, self).__init__()</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">         self.interrupted = False</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> <br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">     def run(self):</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">         while not self.interrupted:</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">             try:</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">                #get next work item</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> <span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">                item = excel_worker_q.get()</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">                 #work on item</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">             except: #when the shit happens</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">         except: #when the shit hits the fan</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> <br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">     def interrupt(self):</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">         self.interrupted = True</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)">  </div><br>'Oh, the horror!' I thought to myself. There was no way to interru... wait a minute! I didn't have to interrupt the <span class="il">worker</span>,  I've landed on a hotline straight to him. The queue was the answer to  all my problems! I could just 'send' him a work item that told him to...  stop working! It was almost genius.<br><div><br><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">excel_worker_q = queue.Queue()</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> <br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> class ExcelUploadWorkerThread:</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">     def __init__(self):</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">         super(ExcelUploadWorkerThread, self).__init__()</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">         self.STOP_SLUG = object()</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> <br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">     def run(self):</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">         while True:</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">             try:</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">                 #get next work item</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">                 item = excel_worker_q.get()</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">                if item is self.STOP_SLUG:</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> <span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">                    break</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">                 #work on item</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">             except: #when the shit happens</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">         except: #when the shit hits the fan</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> <br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">     def interrupt(self):</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">         excel_worker_q.put(self.STOP_<wbr>SLUG)</span><br> </div> <br>Now I had him, it was fool proof now... or so I thought. <b><span style="font-family:courier new,monospace;color:rgb(0, 153, 0)">^C</span></b><br><br>And there he was, I'd finally caught him. 'I got you, you little bugge...' wait what was all that noise behind me?<br><br><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">Traceback (most recent call last):</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">  File "/home/dexterous/py-ve/vs/bin/<wbr>paster", line 9, in <module></module></span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">    load_entry_point('PasteScript=<wbr>=1.7.3', 'console_scripts', 'paster')()</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">  File "/home/dexterous/py-ve/vs/lib/<wbr>python2.6/site-packages/<wbr>PasteScript-1.7.3-py2.6.egg/<wbr>paste/script/command.py", line 84, in run</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">    invoke(command, command_name, options, args[1:])</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">  File "/home/dexterous/py-ve/vs/lib/<wbr>python2.6/site-packages/<wbr>PasteScript-1.7.3-py2.6.egg/<wbr>paste/script/command.py", line 123, in invoke</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">    exit_code = runner.run(args)</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">  File "/home/dexterous/py-ve/vs/lib/<wbr>python2.6/site-packages/<wbr>PasteScript-1.7.3-py2.6.egg/<wbr>paste/script/command.py", line 218, in run</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">    result = self.command()</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">  File "/home/dexterous/py-ve/vs/lib/<wbr>python2.6/site-packages/<wbr>PasteScript-1.7.3-py2.6.egg/<wbr>paste/script/serve.py", line 303, in command</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">    serve()</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">  File "/home/dexterous/py-ve/vs/lib/<wbr>python2.6/site-packages/<wbr>PasteScript-1.7.3-py2.6.egg/<wbr>paste/script/serve.py", line 287, in serve</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">    server(app)</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">  File "/home/dexterous/py-ve/vs/lib/<wbr>python2.6/site-packages/paste/<wbr>deploy/loadwsgi.py", line 151, in server_wrapper</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">    **context.local_conf)</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">  File "/home/dexterous/py-ve/vs/lib/<wbr>python2.6/site-packages/paste/<wbr>deploy/util/fixtypeerror.py", line 57, in fix_call</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">    val = callable(*args, **kw)</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">  File "/home/dexterous/py-ve/vs/lib/<wbr>python2.6/site-packages/paste/<wbr>httpserver.py", line 1342, in server_runner</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">    serve(wsgi_app, **kwargs)</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">  File "/home/dexterous/py-ve/vs/lib/<wbr>python2.6/site-packages/paste/<wbr>httpserver.py", line 1310, in serve</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">    server.serve_forever()</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">  File "/home/dexterous/py-ve/vs/lib/<wbr>python2.6/site-packages/paste/<wbr>httpserver.py", line 1084, in serve_forever</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">    self.handle_request()</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">  File "/usr/lib/python2.6/<wbr>SocketServer.py", line 264, in handle_request</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">    fd_sets = select.select([self], [], [], timeout)</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">select.error: (4, 'Interrupted system call')</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <br>Gadzooks! What had I done? The whole application came crashing down behind us. All I wanted to do was get the <span class="il">worker</span> out of the way so that the app could close gracefully. It turns out that a capturing SIGINT lead to the system calls behind <span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">SocketServer.handle_request</span> being interrupted and it just broke down as it was waiting for the next request.<br><br>Tired and weary, I roped Vineet into the investigation and we  experimented with signal.siginterrupt to see if the system calls could  be continued or, at the least, interrupted a little more nicely. But to  no avail. The BSD-based signalling API in Python just didn't allow for  any of that. We soon concluded that this behaviour was to be expected  when attempting signal handling with another <span class="il">thread</span> waiting on a IO file descriptor, signalling was clearly not the way to go.<br><br>'Hang on,' Vineet said, a gleam in his eyes, 'why don't you just stop the <span class="il">thread</span>  in the teardown of your freshen features?' 'Hmm... I suppose that'd do  it.' I mumbled gazing at the wall across the room. Come to think of it, I  had started out writing freshen features and killing the <span class="il">worker</span> as each scenario concluded would do the trick; at least for now, for the tests.<br><br><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">@After</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">def stop_excel_worker(scenario):</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"> <span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">    from pluto.integration.excel_upload import stop_excelworker</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><span style="font-family:courier new,monospace;color:rgb(51, 51, 255)">    stop_excelworker()</span><br style="font-family:courier new,monospace;color:rgb(51, 51, 255)"><br>And that was it, the last brick in the wall.<br><br><b style="color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace">$ nosetests --with-freshen --with-pylons=test.ini pluto/tests/features/</span><br style="font-family:courier new,monospace"> </b><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">.</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">------------------------------<wbr>------------------------------<wbr>--------</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">Ran 1 test in 0.740s</span><br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"> <br style="font-family:courier new,monospace;color:rgb(0, 102, 0)"><span style="font-family:courier new,monospace;color:rgb(0, 102, 0)">OK</span><br style="color:rgb(0, 102, 0)"><br>And there it was, <span class="il">worker</span>  caught and disposed and application turned down nice and clean as we  expected. This was one case I hope I never have to open again!</div><p></p>
<div style="clear: both;"></div>
</div>
